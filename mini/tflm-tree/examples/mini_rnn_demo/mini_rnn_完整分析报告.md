# mini_rnn_float32.tflite å®Œæ•´åˆ†ææŠ¥å‘Š

> **æ¨¡å‹æ–‡ä»¶**: `mini_rnn_float32.tflite`  
> **æ¨¡å‹å¤§å°**: 378 KB  
> **ç›®æ ‡å¹³å°**: TensorFlow Lite Micro (é€šç”¨åµŒå…¥å¼)  
> **åˆ†ææ—¥æœŸ**: 2026å¹´2æœˆ12æ—¥

---

## ğŸ“‹ ç›®å½•

1. [æ¨¡å‹åŸºæœ¬ä¿¡æ¯](#1-æ¨¡å‹åŸºæœ¬ä¿¡æ¯)
2. [ç½‘ç»œæ¶æ„åˆ†æ](#2-ç½‘ç»œæ¶æ„åˆ†æ)
3. [æ¨ç†æµç¨‹è¯¦è§£](#3-æ¨ç†æµç¨‹è¯¦è§£)
4. [ç‰¹å¾å·¥ç¨‹](#4-ç‰¹å¾å·¥ç¨‹)
5. [åå¤„ç†Pipeline](#5-åå¤„ç†pipeline)
6. [ä¸LLZæ¨¡å‹å¯¹æ¯”](#6-ä¸llzæ¨¡å‹å¯¹æ¯”)

---

## 1. æ¨¡å‹åŸºæœ¬ä¿¡æ¯

### 1.1 åŸºæœ¬è§„æ ¼

```json
{
  "model_version": 3,
  "model_size": "378 KB",
  "precision": "Float32",
  "subgraphs": 1,
  "operator_codes": 18,
  "operator_total": 208,
  "tensor_total": 280
}
```

### 1.2 è¾“å…¥è¾“å‡ºå®šä¹‰

#### è¾“å…¥1: EMGç»„åˆç‰¹å¾
```json
{
  "name": "serving_default_0_emg_combined:0",
  "shape": [1, 50, 32],
  "dtype": "FLOAT32",
  "size": 6400 bytes
}
```
**è¯¦ç»†è¯´æ˜**:
- `batch=1`: å•æ ·æœ¬æ¨ç†
- `time_steps=50`: 50ä¸ªæ—¶é—´æ­¥ï¼ˆ25ms @ 2kHzé‡‡æ ·ç‡ï¼‰
- `features=32`: **ç»„åˆç‰¹å¾** = 16é€šé“ Ã— 2ï¼ˆRaw + Absï¼‰
- **å…³é”®**: è¾“å…¥å·²ç»åŒ…å«äº† `[åŸå§‹å€¼, ç»å¯¹å€¼]` çš„ç‰¹å¾å·¥ç¨‹

#### è¾“å…¥2: GRUéšè—çŠ¶æ€
```json
{
  "name": "serving_default_1_state_input:0",
  "shape": [1, 128],
  "dtype": "FLOAT32",
  "size": 512 bytes
}
```
**è¯¦ç»†è¯´æ˜**:
- `hidden_size=128`: GRUçš„éšè—å±‚ç»´åº¦
- ä½œç”¨: ä¿æŒæ—¶åºè®°å¿†ï¼Œè·¨å¸§ä¼ é€’

#### è¾“å‡º1: æ›´æ–°çš„GRUçŠ¶æ€
```json
{
  "name": "StatefulPartitionedCall_1:1",
  "shape": [1, 128],
  "dtype": "FLOAT32"
}
```
- ä¸‹ä¸€å¸§æ¨ç†æ—¶éœ€è¦å›ä¼ 

#### è¾“å‡º2: æ‰‹åŠ¿é¢„æµ‹
```json
{
  "name": "StatefulPartitionedCall_1:0",
  "shape": [1, 9],
  "dtype": "FLOAT32"
}
```
- **9ç§æ‰‹åŠ¿**çš„logitsï¼ˆæœªå½’ä¸€åŒ–ï¼‰

---

## 2. ç½‘ç»œæ¶æ„åˆ†æ

### 2.1 æ“ä½œç¬¦ç»Ÿè®¡

| æ“ä½œç±»å‹ | æ•°é‡ | ä¸»è¦ç”¨é€” |
|---------|------|---------|
| **FULLY_CONNECTED** | 21 | GRUé—¨æ§ã€è¾“å‡ºæŠ•å½± |
| **LOGISTIC** | 21 | Sigmoidæ¿€æ´»ï¼ˆGRUé—¨æ§ï¼‰ |
| **ADD** | 43 | åç½®ã€æ®‹å·®è¿æ¥ |
| **MUL** | 33 | é—¨æ§ä¹˜æ³•ã€ç¼©æ”¾ |
| **STRIDED_SLICE** | 31 | å¼ é‡åˆ‡ç‰‡ï¼ˆçŠ¶æ€åˆ†ç¦»ï¼‰ |
| **TANH** | 10 | Tanhæ¿€æ´»ï¼ˆGRUï¼‰ |
| **SUB** | 10 | å‡æ³•ï¼ˆå½’ä¸€åŒ–ï¼‰ |
| **SPLIT** | 10 | å¼ é‡åˆ†å‰² |
| **CONV_2D** | 5 | å·ç§¯ç‰¹å¾æå– |
| **PAD** | 4 | å¡«å……ï¼ˆå·ç§¯å‰å¤„ç†ï¼‰ |
| **CONCATENATION** | 2 | å¼ é‡æ‹¼æ¥ |
| **MEAN** | 2 | å‡å€¼è®¡ç®— |
| **AVERAGE_POOL_2D** | 1 | æ± åŒ– |
| **RESHAPE** | 11 | å½¢çŠ¶å˜æ¢ |
| **NEG** | 1 | å–è´Ÿ |
| **SQUARED_DIFFERENCE** | 1 | æ–¹å·®è®¡ç®— |
| **RSQRT** | 1 | å¹³æ–¹æ ¹å€’æ•° |
| **UNPACK** | 1 | è§£åŒ… |

### 2.2 æ¨æµ‹ç½‘ç»œç»“æ„

åŸºäºæ“ä½œç¬¦åˆ†æï¼Œæ¨æµ‹æ¶æ„ä¸ºï¼š

```
è¾“å…¥: EMG_Combined[1,50,32] + State[1,128]
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç‰¹å¾æå–å±‚                          â”‚
â”‚  â”œâ”€ PAD + CONV_2D (5å±‚)             â”‚
â”‚  â”œâ”€ AVERAGE_POOL_2D                 â”‚
â”‚  â””â”€ æå–å±€éƒ¨æ—¶ç©ºç‰¹å¾                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GRUå±‚ (Gated Recurrent Unit)       â”‚
â”‚  â”œâ”€ æ›´æ–°é—¨ (Update Gate)            â”‚
â”‚  â”‚   z_t = Ïƒ(W_zÂ·[h_{t-1}, x_t])   â”‚
â”‚  â”œâ”€ é‡ç½®é—¨ (Reset Gate)             â”‚
â”‚  â”‚   r_t = Ïƒ(W_rÂ·[h_{t-1}, x_t])   â”‚
â”‚  â”œâ”€ å€™é€‰æ¿€æ´»                         â”‚
â”‚  â”‚   hÌƒ_t = tanh(W_hÂ·[r_tâŠ™h_{t-1}, x_t]) â”‚
â”‚  â””â”€ çŠ¶æ€æ›´æ–°                         â”‚
â”‚      h_t = (1-z_t)âŠ™h_{t-1} + z_tâŠ™hÌƒ_t  â”‚
â”‚                                       â”‚
â”‚  å…¨è¿æ¥(FC): 21ä¸ª                     â”‚
â”‚  Sigmoid: 21ä¸ª (é—¨æ§)                 â”‚
â”‚  Tanh: 10ä¸ª (æ¿€æ´»)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¾“å‡ºæŠ•å½±å±‚                           â”‚
â”‚  FC[128 â†’ 9]                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“
è¾“å‡º: Logits[1,9] + NewState[1,128]
```

### 2.3 GRUè¯¦ç»†ç»“æ„

**GRU vs LSTM**:
- LSTM: 3ä¸ªé—¨ï¼ˆè¾“å…¥/é—å¿˜/è¾“å‡ºï¼‰+ Cell State
- **GRU**: 2ä¸ªé—¨ï¼ˆæ›´æ–°/é‡ç½®ï¼‰æ›´ç®€æ´ï¼Œå‚æ•°å°‘

**GRUå…¬å¼**:
```
æ›´æ–°é—¨: z_t = Ïƒ(W_zÂ·x_t + U_zÂ·h_{t-1} + b_z)
é‡ç½®é—¨: r_t = Ïƒ(W_rÂ·x_t + U_rÂ·h_{t-1} + b_r)
å€™é€‰:   hÌƒ_t = tanh(W_hÂ·x_t + U_hÂ·(r_t âŠ™ h_{t-1}) + b_h)
è¾“å‡º:   h_t = (1 - z_t) âŠ™ h_{t-1} + z_t âŠ™ hÌƒ_t
```

**æ“ä½œå¯¹åº”**:
- `FULLY_CONNECTED Ã— 21`: å®ç° W_z, U_z, W_r, U_r, W_h, U_h ç­‰çŸ©é˜µä¹˜æ³•
- `LOGISTIC Ã— 21`: å®ç°æ›´æ–°é—¨å’Œé‡ç½®é—¨çš„Sigmoid
- `TANH Ã— 10`: å®ç°å€™é€‰æ¿€æ´»
- `MUL Ã— 33`: å®ç°é—¨æ§ä¹˜æ³• (âŠ™)
- `ADD Ã— 43`: å®ç°åç½®å’ŒçŠ¶æ€èåˆ

---

## 3. æ¨ç†æµç¨‹è¯¦è§£

### 3.1 å®Œæ•´Pipeline

```cpp
// ========== ä¸»å‡½æ•°æµç¨‹ ==========
int main() {
    // 1. åˆå§‹åŒ–æ¨¡å‹
    MiniRNNHandler handler;
    handler.Initialize();
    
    // 2. åˆå§‹åŒ–åå¤„ç†ç»„ä»¶
    GestureDebouncer debouncer({0.40f, 20, 0.15f});
    FingerStateMachine finger_state;
    OnlineNormalizer normalizer(0.001f, adaptive_norm);
    
    // 3. æ‰“å¼€EMGæ•°æ®æ–‡ä»¶
    FILE* file = fopen("dataset.bin", "rb");
    
    // 4. æ»‘åŠ¨çª—å£åˆå§‹åŒ–
    float window[50][16] = {0};  // 50æ­¥ Ã— 16é€šé“
    
    // 5. é€æ ·æœ¬è¯»å–å¹¶æ¨ç†
    while (read_sample(&sample)) {
        // A. çª—å£æ»‘åŠ¨ (sample-by-sample)
        memmove(window, window+1, 49*sizeof(window[0]));
        memcpy(window[49], sample.emg, sizeof(sample.emg));
        
        // B. æ¯20æ­¥æ‰§è¡Œä¸€æ¬¡æ¨ç† (10msé—´éš”)
        if ((total_samples - 50) % 20 == 0) {
            // i. å½’ä¸€åŒ–
            normalizer.Normalize(window);
            
            // ii. æ¨ç†
            handler.RunInference(window, probs);
            
            // iii. åå¤„ç†
            int32_t gesture = debouncer.Process(probs);
            
            // iv. çŠ¶æ€æœºè¿‡æ»¤
            if (!finger_state.ShouldFilter(gesture)) {
                finger_state.Update(gesture);
                // è¾“å‡ºæ£€æµ‹ç»“æœ
            }
        }
    }
}
```

### 3.2 å…³é”®å‚æ•°é…ç½®

```cpp
// æ—¶åºå‚æ•°
const int kSeqLen = 50;        // 50æ ·æœ¬ = 25ms @ 2kHz
const int kStride = 20;        // æ¨ç†æ­¥é•¿ = 10ms
const int kSampleRate = 2000;  // 2000 Hzé‡‡æ ·ç‡

// æ¨¡å‹å‚æ•°
const int kNumChannels = 16;   // 16é€šé“EMG
const int kNumGestures = 9;    // 9ç§æ‰‹åŠ¿
const int kHiddenSize = 128;   // GRUéšè—å±‚ç»´åº¦

// å†…å­˜é…ç½®
const int kTensorArenaSize = 384 * 1024;  // 384 KB
```

### 3.3 æ ¸å¿ƒæ¨ç†å‡½æ•°è¯¦è§£

```cpp
int32_t MiniRNNHandler::RunInference(
    const float window[50][16], 
    float* probs,
    bool apply_std
) {
    // ========================================
    // æ­¥éª¤1: ç‰¹å¾å·¥ç¨‹ [Raw, Abs]
    // ========================================
    for (int t = 0; t < 50; ++t) {
        for (int c = 0; c < 16; ++c) {
            // Z-Scoreå½’ä¸€åŒ–
            float val = apply_std ? 
                (window[t][c] - kNormMean[c]) / (kNormStd[c] + 1e-6f)
                : window[t][c];
            
            // äº¤ç»‡å­˜å‚¨: [raw0, raw1, ..., raw15, abs0, abs1, ..., abs15]
            int idx = t * 32 + c;
            input_emg_->data.f[idx] = val;                  // åŸå§‹å€¼
            input_emg_->data.f[idx + 16] = std::abs(val);  // ç»å¯¹å€¼
        }
    }
    
    // ========================================
    // æ­¥éª¤2: è®¾ç½®GRUçŠ¶æ€è¾“å…¥
    // ========================================
    std::copy(hidden_state_, 
              hidden_state_ + 128, 
              input_state_->data.f);
    
    // ========================================
    // æ­¥éª¤3: TFLiteæ¨ç†
    // ========================================
    if (interpreter_->Invoke() != kTfLiteOk) return -1;
    
    // ========================================
    // æ­¥éª¤4: æå–ç»“æœå¹¶æ›´æ–°çŠ¶æ€
    // ========================================
    for (int i = 0; i < 9; ++i) {
        probs[i] = output_probs_->data.f[i];  // logits
    }
    
    for (int i = 0; i < 128; ++i) {
        hidden_state_[i] = output_state_->data.f[i];  // æ–°çŠ¶æ€
    }
    
    return 0;
}
```

---

## 4. ç‰¹å¾å·¥ç¨‹

### 4.1 Raw + Absç‰¹å¾

**ä¸ºä»€ä¹ˆéœ€è¦ç»å¯¹å€¼ç‰¹å¾ï¼Ÿ**

```python
# EMGä¿¡å·çš„ç‰¹ç‚¹
åŸå§‹EMG: [..., -50, -30, 10, 45, ...]  # æœ‰æ­£æœ‰è´Ÿ
ç»å¯¹å€¼:  [...,  50,  30, 10, 45, ...]  # åªæœ‰å¹…åº¦

# ç‰©ç†æ„ä¹‰
- Raw: ä¿ç•™ä¿¡å·çš„æ–¹å‘æ€§ä¿¡æ¯ï¼ˆè‚Œè‚‰ä¼¸å±•/æ”¶ç¼©ï¼‰
- Abs: æå–è‚Œè‚‰æ´»åŠ¨çš„å¼ºåº¦ï¼ˆå¹…åº¦ç‰¹å¾ï¼‰
```

**ä»£ç å®ç°**:
```cpp
// è¾“å…¥å½¢çŠ¶: [1, 50, 32]
// å…¶ä¸­ 32 = 16ä¸ªrawé€šé“ + 16ä¸ªabsé€šé“

input[t, :16]  = raw_emg[t, :]      // é€šé“0-15: åŸå§‹å€¼
input[t, 16:] = abs(raw_emg[t, :])  // é€šé“16-31: ç»å¯¹å€¼
```

### 4.2 Z-Scoreå½’ä¸€åŒ–

```cpp
const float kNormMean[16] = {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};
const float kNormStd[16] = {
    6.013952f, 5.859423f, 6.209393f, 7.271179f,
    12.334139f, 11.997432f, 4.842080f, 5.316736f,
    5.355888f, 6.679272f, 7.037768f, 8.026479f,
    11.293577f, 14.077667f, 10.762142f, 7.953421f
};

// å½’ä¸€åŒ–å…¬å¼
normalized = (raw - mean) / (std + epsilon)
```

**å„é€šé“æ ‡å‡†å·®å·®å¼‚**:
- é€šé“4: 12.33 (é«˜å˜åŒ–)
- é€šé“13: 14.08 (æœ€é«˜)
- é€šé“6: 4.84 (ä½å˜åŒ–)

**è§£é‡Š**: ä¸åŒé€šé“å¯¹åº”ä¸åŒè‚Œè‚‰ä½ç½®ï¼Œæ´»åŠ¨å¼ºåº¦ä¸åŒ

### 4.3 è‡ªé€‚åº”å½’ä¸€åŒ– (å¯é€‰)

```cpp
class OnlineNormalizer {
    // æŒ‡æ•°ç§»åŠ¨å¹³å‡ (EMA)
    float alpha = 0.001f;
    
    void Normalize(float window[50][16]) {
        // 1. è®¡ç®—å½“å‰çª—å£ç»Ÿè®¡é‡
        float batch_mean[16], batch_std[16];  // é€é€šé“
        
        // 2. æ›´æ–°è¿è¡Œç»Ÿè®¡é‡
        if (!initialized) {
            running_mean = batch_mean;
            running_std = batch_std;
            initialized = true;
        } else {
            running_mean = alpha * batch_mean + 
                          (1-alpha) * running_mean;
            running_std = alpha * batch_std + 
                         (1-alpha) * running_std;
        }
        
        // 3. å½’ä¸€åŒ–
        for (t, c) {
            window[t][c] = (window[t][c] - running_mean[c]) 
                          / running_std[c];
        }
    }
};
```

**ç”¨é€”**: 
- é€‚åº”ä¸åŒç”¨æˆ·/ç”µæä½ç½®çš„ä¿¡å·å·®å¼‚
- åœ¨çº¿æ ¡å‡†ï¼Œæ— éœ€ç¦»çº¿ç»Ÿè®¡

---

## 5. åå¤„ç†Pipeline

### 5.1 GestureDebouncer (å»æŠ–åŠ¨å™¨)

**ç›®çš„**: ç¨³å®šè¾“å‡ºï¼Œé˜²æ­¢è¯¯è§¦å‘

```cpp
struct Config {
    float threshold_on = 0.40f;      // è§¦å‘é˜ˆå€¼
    int lockout_frames = 20;         // 200msé”å®šæœŸ
    float competition_margin = 0.15f; // ç«äº‰è¾¹ç•Œ
};
```

#### 5.1.1 èƒ½é‡ç§¯åˆ†

```cpp
// Leaky Bucketç§¯åˆ† (Î±=0.1)
energies[i] = 0.9 * energies[i] + 0.1 * probs[i];
```

**ç‰©ç†æ„ä¹‰**:
```
âˆ« P(t) dt â‰ˆ Î£ P[i] * 0.1
```
- å•æ¬¡é«˜æ¦‚ç‡ä¸è§¦å‘ (é˜²æ­¢å™ªå£°)
- æŒç»­é«˜æ¦‚ç‡æ‰ç´¯ç§¯è§¦å‘ (å¯é æ€§)

#### 5.1.2 ç«äº‰æ£€æµ‹

```cpp
// æ‰¾Top-2æ¦‚ç‡
float p1 = max(probs), p2 = second_max(probs);
bool is_ambiguous = (p1 - p2) < 0.15f;

// ä»…åœ¨æ¸…æ™°æ—¶è§¦å‘
if (!is_ambiguous && energy[best] > threshold) {
    trigger();
}
```

**ä¾‹å­**:
```
æ¸…æ™°: [0.8, 0.1, 0.05, ...] â†’ p1-p2=0.7 > 0.15 âœ“ è§¦å‘
æ¨¡ç³Š: [0.5, 0.4, 0.05, ...] â†’ p1-p2=0.1 < 0.15 âœ— æŠ‘åˆ¶
```

#### 5.1.3 é”å®šæœºåˆ¶

```cpp
if (triggered) {
    lockout[gesture_id] = 20;    // 200mså†…ä¸å†è§¦å‘åŒä¸€æ‰‹åŠ¿
    global_lockout = 5;          // 50mså…¨å±€é™é»˜æœŸ
    fill(energies, 0);           // æ¸…ç©ºèƒ½é‡
}
```

**æ—¶åºå›¾**:
```
æ—¶é—´è½´: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’
         T0    T1    T2    ...   T20
         â–²
         â”‚ æ£€æµ‹åˆ°index_press
         â”‚
         â”œâ”€ lockout[0] = 20
         â”‚  global_lockout = 5
         â”‚
         â””â”€ æ¥ä¸‹æ¥200mså†…ï¼š
            - index_pressè¢«æŠ‘åˆ¶
            - å‰50msæ‰€æœ‰æ‰‹åŠ¿è¢«æŠ‘åˆ¶
```

---

### 5.2 FingerStateMachine (çŠ¶æ€æœº)

**ç›®çš„**: è¿‡æ»¤é€»è¾‘ä¸å¯èƒ½çš„æ‰‹åŠ¿åºåˆ—

```cpp
enum State { NEUTRAL, INDEX, MIDDLE };

// çŠ¶æ€è½¬ç§»è§„åˆ™
NEUTRAL + index_press   â†’ INDEX
INDEX   + index_release â†’ NEUTRAL
NEUTRAL + middle_press  â†’ MIDDLE
MIDDLE  + middle_release â†’ NEUTRAL

// è¿‡æ»¤è§„åˆ™
- NEUTRALçŠ¶æ€: ç¦æ­¢ *_release (æ‰‹æŒ‡æœªæŒ‰ä¸‹æ€ä¹ˆé‡Šæ”¾ï¼Ÿ)
- INDEXçŠ¶æ€: ç¦æ­¢ middle_release (ä¸­æŒ‡æœªåŠ¨)
- MIDDLEçŠ¶æ€: ç¦æ­¢ index_release (é£ŸæŒ‡æœªåŠ¨)
```

**çŠ¶æ€å›¾**:
```
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚   NEUTRAL   â”‚ â—„â”€â”€â”€ åˆå§‹çŠ¶æ€
       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
              â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
       â”‚             â”‚
  index_press   middle_press
       â”‚             â”‚
       â–¼             â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ INDEX  â”‚   â”‚ MIDDLE  â”‚
  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
       â”‚            â”‚
  index_rel    middle_rel
       â”‚            â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
                â–¼
           [NEUTRAL]
```

**è¿‡æ»¤ç¤ºä¾‹**:
```cpp
// æ­£å¸¸åºåˆ— âœ“
NEUTRAL â†’ index_press â†’ INDEX â†’ index_release â†’ NEUTRAL

// å¼‚å¸¸åºåˆ— âœ— (è¢«è¿‡æ»¤)
NEUTRAL â†’ index_release  // è¿‡æ»¤ï¼šæ— æ³•ä»æœªæŒ‰ä¸‹é‡Šæ”¾
INDEX â†’ middle_release   // è¿‡æ»¤ï¼šä¸­æŒ‡çŠ¶æ€ä¸å¯¹
```

---

### 5.3 å®Œæ•´åå¤„ç†æµç¨‹

```cpp
int32_t ProcessGesture(float* raw_probs) {
    // ========== æ­¥éª¤1: å»æŠ–åŠ¨ ==========
    int32_t candidate = debouncer.Process(raw_probs);
    // è¾“å‡º: å€™é€‰æ‰‹åŠ¿ID æˆ– -1 (æœªè§¦å‘)
    
    if (candidate == -1) return -1;  // æ— è§¦å‘
    
    // ========== æ­¥éª¤2: çŠ¶æ€æœºè¿‡æ»¤ ==========
    if (finger_state.ShouldFilter(candidate)) {
        return -1;  // é€»è¾‘è¿è§„ï¼Œä¸¢å¼ƒ
    }
    
    // ========== æ­¥éª¤3: æ›´æ–°çŠ¶æ€ ==========
    finger_state.Update(candidate);
    
    // ========== æ­¥éª¤4: è¾“å‡ºç»“æœ ==========
    // æ„é€ Top-3æ˜¾ç¤ºï¼ˆä»…æ˜¾ç¤ºprob>=0.2ï¼‰
    vector<Pred> sorted_probs = sort_descending(raw_probs);
    for (int k = 0; k < 3 && sorted_probs[k].p >= 0.2; k++) {
        printf("%s/%.2f ", 
               gesture_names[sorted_probs[k].id], 
               sorted_probs[k].p);
    }
    
    return candidate;
}
```

**è¾“å‡ºç¤ºä¾‹**:
```
0.125: [âœ”] index_press/0.85 thumb_up/0.32 index_release/0.21
0.135: [âœ”] middle_press/0.78 thumb_down/0.25
```

---

## 6. ä¸LLZæ¨¡å‹å¯¹æ¯”

| é¡¹ç›® | mini_rnn_float32 | model_data (LLZ) |
|------|-----------------|------------------|
| **æ¨¡å‹å¤§å°** | 378 KB | 118 KB |
| **çª—å£å¤§å°** | 50æ­¥ (25ms) | 32æ­¥ (16ms) |
| **æ¨ç†æ­¥é•¿** | 20æ­¥ (10ms) | 20æ­¥ (10ms) |
| **ç‰¹å¾ç»´åº¦** | 32 (Raw+Abs) | 16 (Raw only) |
| **RNNç±»å‹** | **GRU** | **MinLSTM** |
| **éšè—å±‚** | 128ç»´ | 32ç»´ |
| **å·ç§¯å±‚** | 5å±‚ | 1å±‚ |
| **æ“ä½œæ•°** | 208 | 66 |
| **è¾“å…¥å¸ƒå±€** | Time-Major [1,50,32] | Channel-Major [1,16,32] |
| **å½’ä¸€åŒ–** | Z-Score (é¢„ç½®) + è‡ªé€‚åº” | Reinhardå‹ç¼© |
| **åå¤„ç†** | Debouncer + StateMachine | æ— ï¼ˆç”±ä¸Šä½æœºå¤„ç†ï¼‰ |
| **Arenaéœ€æ±‚** | 384 KB | 60 KB |
| **ç›®æ ‡å¹³å°** | é€šç”¨MCU/åµŒå…¥å¼Linux | ESP32-S3 (ä¸“ç”¨) |

---

## 7. æ€§èƒ½ä¸åº”ç”¨

### 7.1 æ¨æµ‹æ€§èƒ½æŒ‡æ ‡

**å»¶è¿Ÿåˆ†è§£**:
```
æ•°æ®é‡‡é›†: 25ms (50æ ·æœ¬)
æ¨ç†è®¡ç®—: ~30-80ms (å–å†³äºç¡¬ä»¶)
åå¤„ç†:   <1ms
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ€»å»¶è¿Ÿ:   ~50-110ms
```

**é€‚ç”¨ç¡¬ä»¶**:
- ARM Cortex-M7 (STM32H7)
- ARM Cortex-Aç³»åˆ— (æ ‘è“æ´¾)
- ESP32-S3 (éœ€ä¼˜åŒ–Arenaå¤§å°)
- x86åµŒå…¥å¼å¹³å°

### 7.2 ä¼˜åŠ¿

1. **æ›´å¼ºè¡¨è¾¾èƒ½åŠ›**:
   - 5å±‚å·ç§¯ â†’ æ›´ä¸°å¯Œçš„ç©ºé—´ç‰¹å¾
   - 128ç»´GRU â†’ æ›´é•¿çš„æ—¶åºè®°å¿†
   - Raw+Abs â†’ åŒé‡ç‰¹å¾å¢å¼º

2. **æ›´å®Œæ•´çš„Pipeline**:
   - å†…ç½®å»æŠ–åŠ¨é€»è¾‘
   - çŠ¶æ€æœºä¿è¯é€»è¾‘ä¸€è‡´æ€§
   - è‡ªé€‚åº”å½’ä¸€åŒ–æ”¯æŒ

3. **æ›´æ˜“é›†æˆ**:
   - å•ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶
   - æ ‡å‡†POSIXæ¥å£
   - å‘½ä»¤è¡Œå‚æ•°å¯è°ƒ

### 7.3 æƒè¡¡

**vs LLZæ¨¡å‹**:
- âœ… ç²¾åº¦å¯èƒ½æ›´é«˜
- âœ… é²æ£’æ€§æ›´å¼º
- âŒ è®¡ç®—é‡æ˜¾è‘—å¢åŠ  (3å€+)
- âŒ å†…å­˜éœ€æ±‚å¤§ (6å€+)
- âŒ åŠŸè€—æ›´é«˜

**é€‰æ‹©å»ºè®®**:
```
mini_rnn      â† æ€§èƒ½å……è¶³ï¼Œè¿½æ±‚ç²¾åº¦
model_data    â† èµ„æºå—é™ï¼Œå®æ—¶è¦æ±‚é«˜
```

---

## 8. è°ƒè¯•ä¸éªŒè¯

### 8.1 å‘½ä»¤è¡Œå‚æ•°

```bash
# åŸºæœ¬è¿è¡Œ
./mini_rnn_demo

# æŒ‡å®šæ•°æ®é›†
./mini_rnn_demo --dataset path/to/data.bin

# è°ƒæ•´é˜ˆå€¼
./mini_rnn_demo --threshold 0.35

# å¯ç”¨è‡ªé€‚åº”å½’ä¸€åŒ–
./mini_rnn_demo --adaptive_norm
```

### 8.2 æ•°æ®æ ¼å¼

```cpp
struct BinarySample {
    double timestamp;    // æ—¶é—´æˆ³ (ç§’)
    float emg[16];      // 16é€šé“EMG
};
// æ–‡ä»¶: è¿ç»­çš„BinarySampleæ•°ç»„
```

### 8.3 è¾“å‡ºæ ¼å¼

```
æ—¶é—´æˆ³: [âœ”] Top3æ‰‹åŠ¿/æ¦‚ç‡
0.125: [âœ”] index_press/0.85 thumb_up/0.32
```

---

## 9. ä»£ç ç»“æ„æ€»ç»“

```cpp
main.cc
â”œâ”€â”€ OnlineNormalizer       // è‡ªé€‚åº”å½’ä¸€åŒ–
â”œâ”€â”€ FingerStateMachine     // çŠ¶æ€æœºè¿‡æ»¤
â”œâ”€â”€ GestureDebouncer       // å»æŠ–åŠ¨å™¨
â”‚   â”œâ”€â”€ èƒ½é‡ç§¯åˆ†
â”‚   â”œâ”€â”€ ç«äº‰æ£€æµ‹
â”‚   â””â”€â”€ é”å®šæœºåˆ¶
â””â”€â”€ MiniRNNHandler         // TFLiteæ¨ç†
    â”œâ”€â”€ Initialize()       // æ¨¡å‹åŠ è½½
    â”œâ”€â”€ RunInference()     // æ¨ç†æ‰§è¡Œ
    â”‚   â”œâ”€â”€ ç‰¹å¾å·¥ç¨‹
    â”‚   â”œâ”€â”€ çŠ¶æ€è®¾ç½®
    â”‚   â”œâ”€â”€ Invoke()
    â”‚   â””â”€â”€ ç»“æœæå–
    â””â”€â”€ ResetState()       // çŠ¶æ€é‡ç½®
```

---

## é™„å½•A: GRU vs LSTM

| ç‰¹æ€§ | GRU | LSTM |
|------|-----|------|
| **é—¨æ•°é‡** | 2 (æ›´æ–°/é‡ç½®) | 3 (è¾“å…¥/é—å¿˜/è¾“å‡º) |
| **çŠ¶æ€æ•°** | 1 (hidden) | 2 (hidden + cell) |
| **å‚æ•°é‡** | è¾ƒå°‘ | è¾ƒå¤š |
| **è®¡ç®—é‡** | è¾ƒå°‘ | è¾ƒå¤š |
| **è¡¨è¾¾èƒ½åŠ›** | ç•¥å¼± | ç•¥å¼º |
| **é€‚ç”¨åœºæ™¯** | èµ„æºå—é™ | å¤æ‚ä»»åŠ¡ |

**æœ¬æ¨¡å‹é€‰æ‹©GRUçš„åŸå› **:
- åµŒå…¥å¼å¹³å°èµ„æºæœ‰é™
- æ‰‹åŠ¿è¯†åˆ«ä»»åŠ¡ç›¸å¯¹ç®€å•
- GRUè¶³å¤Ÿèƒœä»»

---

## é™„å½•B: 9ç§æ‰‹åŠ¿å®šä¹‰

```cpp
0: index_press      (é£ŸæŒ‡æŒ‰ä¸‹)
1: index_release    (é£ŸæŒ‡é‡Šæ”¾)
2: middle_press     (ä¸­æŒ‡æŒ‰ä¸‹)
3: middle_release   (ä¸­æŒ‡é‡Šæ”¾)
4: thumb_click      (æ‹‡æŒ‡ç‚¹å‡»)
5: thumb_down       (æ‹‡æŒ‡å‘ä¸‹)
6: thumb_in         (æ‹‡æŒ‡å‘å†…)
7: thumb_out        (æ‹‡æŒ‡å‘å¤–)
8: thumb_up         (æ‹‡æŒ‡å‘ä¸Š)
```

---

## é™„å½•C: æ–‡ä»¶æ¸…å•

```
mini_rnn_demo/
â”œâ”€â”€ mini_rnn_float32.tflite              # æ¨¡å‹æ–‡ä»¶ (378KB)
â”œâ”€â”€ mini_rnn_float32.tflite.report.json  # è¯¦ç»†åˆ†ææŠ¥å‘Š
â”œâ”€â”€ mini_rnn_float32.tflite.summary.json # ç®€è¦ç»Ÿè®¡
â”œâ”€â”€ main.cc                              # ä¸»æ¨ç†ç¨‹åº â­
â””â”€â”€ model_data.cc                        # æ¨¡å‹æ•°æ®ï¼ˆå¯èƒ½æ˜¯Cæ•°ç»„ï¼‰
```

---

**åˆ†æå®Œæˆæ—¶é—´**: 2026å¹´2æœˆ12æ—¥  
**ç‰ˆæœ¬**: v1.0  
**åˆ†æè€…**: AI Assistant
